<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Music Messer</title>
<style>
  :root{
    --bg:#0b0b0d; --panel:#121216; --muted:#2a2a31; --line:#202028;
    --accent:#7df9ff; --accent2:#ff7a8a; --txt:#e8e8ee; --txt-dim:#b9bac6;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--txt);font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", sans-serif}
  #app{display:flex;flex-direction:column;min-height:100vh}
  header{
    display:flex;align-items:center;justify-content:space-between;gap:.5rem;
    padding:.6rem .8rem;border-bottom:1px solid var(--line);
    background:linear-gradient(180deg, #121216, #0f0f13);
    position:sticky;top:0;z-index:10;
  }
  .title{font-weight:900;letter-spacing:.3px}
  .toolbar{display:flex;gap:.5rem;flex-wrap:wrap}
  button, .btn{
    appearance:none;border:1px solid var(--line);background:linear-gradient(180deg,#1a1a20,#121216);
    color:var(--txt);border-radius:8px;padding:.5rem .7rem;font-weight:700;letter-spacing:.3px;cursor:pointer;
  }
  button:disabled{opacity:.5;cursor:not-allowed}
  button:active{transform:translateY(1px)}
  .pill{border-radius:999px}
  .on{box-shadow:0 0 0 1px var(--accent) inset; color:var(--accent)}
  .danger{color:#ff9aa2;border-color:#3a1f25}
  main{flex:1;display:flex;align-items:center;justify-content:center;padding:10px}
  .page{display:none;width:100%;max-width:1100px}
  .page.active{display:block}
  .home-grid{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr));width:100%}
  .card{
    background:linear-gradient(180deg,#15151a,#101014);border:1px solid var(--line);border-radius:14px;padding:1rem;min-height:120px;
    display:flex;align-items:flex-end;justify-content:space-between;position:relative;overflow:hidden;
  }
  .card h3{margin:0 0 .2rem 0}
  .card .sub{color:var(--txt-dim);font-size:.9rem}
  .card .art{position:absolute;inset:auto 8px 8px auto;opacity:.2;font-size:56px}
  .piano-wrap{background:linear-gradient(180deg,#0f1115,#0b0c10);border:1px solid var(--line);border-radius:12px;padding:8px}
  .piano{display:flex;position:relative;height:min(44vh,280px);user-select:none;touch-action:none;}
  .white{flex:1;border:1px solid #30303a;border-bottom:none;background:linear-gradient(180deg,#f4f4f7,#d9d9e0);border-radius:0 0 6px 6px;position:relative}
  .white:active{filter:brightness(0.9)}
  .black{position:absolute;top:0;width:60%;height:66%;background:linear-gradient(180deg,#101014,#0c0d12);border:1px solid #22232a;border-bottom:none;border-radius:0 0 5px 5px;z-index:2;left:70%;transform:translateX(-50%);box-shadow:0 6px 8px rgba(0,0,0,.5) inset;}
  .label{position:absolute;bottom:6px;left:8px;color:#222;font-weight:700;font-size:12px}
  .fretboard{background:linear-gradient(180deg,#1b1b20,#121216);border:1px solid var(--line);border-radius:12px;padding:10px;position:relative;}
  .board{position:relative;height:min(46vh,320px);border-radius:8px;background:
      repeating-linear-gradient(90deg, #2a2a31 0 2px, transparent 2px 70px),
      linear-gradient(180deg,#26262d,#1a1a20);
    border:1px solid #23232a; overflow:hidden;}
  .string{position:absolute;left:0;right:0;height:2px;background:linear-gradient(90deg,#999,#ccc,#999);box-shadow:0 0 0 1px #0006 inset;}
  .string:nth-child(1){top:8%}.string:nth-child(2){top:24%}.string:nth-child(3){top:40%}.string:nth-child(4){top:56%}.string:nth-child(5){top:72%}.string:nth-child(6){top:88%}
  .strings-4 .string:nth-child(5), .strings-4 .string:nth-child(6){display:none}
  .markers{position:absolute;left:0;right:0;top:0;bottom:0;pointer-events:none}
  .dot{position:absolute;width:10px;height:10px;border-radius:50%;background:#888;opacity:.6;transform:translate(-50%, -50%)}
  .fret-number{position:absolute;bottom:6px;color:#6c6d78;font-size:12px}
  .drums{display:grid;gap:10px;grid-template-columns:repeat(3,minmax(0,1fr));}
  .pad{background:linear-gradient(180deg,#1c1e24,#14161b);border:1px solid #2c2f37;border-radius:12px;height:120px;display:flex;align-items:center;justify-content:center;font-weight:900;letter-spacing:.4px;color:#cfd2e6;box-shadow:0 6px 0 #0c0e12 inset;user-select:none;touch-action:none;}
  .pad:active{transform:translateY(1px); filter:brightness(1.1)}
  .recbar{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;justify-content:center;margin:.6rem 0 .2rem}
  audio{width:100%;margin-top:.4rem}
  .backbtn{display:flex;align-items:center;gap:.4rem}
  .hidden{display:none}
  /* Start overlay */
  #startOverlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:9999}
  #startOverlay .box{background:linear-gradient(180deg,#15151a,#101014);border:1px solid var(--line);border-radius:14px;padding:16px 20px;text-align:center;max-width:360px}
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="backbtn">
      <button id="backBtn" class="btn pill">‚üµ Home</button>
      <div class="title">Music Messer</div>
    </div>
    <div class="toolbar">
      <button id="loopBtn" class="btn pill">Loop</button>
      <button id="clearLoopBtn" class="btn pill">Clear Loop</button>
      <button id="recBtn" class="btn pill">‚óè Record</button>
      <button id="stopRecBtn" class="btn pill danger">‚ñ† Stop</button>
      <button id="playRecBtn" class="btn pill" disabled>‚ñ∂ Play Take</button>
      <a id="dlLink" class="btn pill" download>‚¨á Download</a>
    </div>
  </header>

  <main>
    <!-- HOME -->
    <section id="home" class="page active">
      <div class="home-grid">
        <button class="card" data-nav="piano" aria-label="Piano">
          <div><h3>Piano</h3><div class="sub">Tap keys to play</div></div><div class="art">üéπ</div>
        </button>
        <button class="card" data-nav="guitar" aria-label="Guitar">
          <div><h3>Electric/Acoustic Guitar</h3><div class="sub">Tap string & fret</div></div><div class="art">üé∏</div>
        </button>
        <button class="card" data-nav="bass" aria-label="Bass">
          <div><h3>Bass Guitar</h3><div class="sub">4 strings</div></div><div class="art">üé∏</div>
        </button>
        <button class="card" data-nav="drums" aria-label="Drums">
          <div><h3>Drum Kit</h3><div class="sub">Pad layout</div></div><div class="art">ü•Å</div>
        </button>
      </div>
      <div class="recbar" style="color:var(--txt-dim);text-align:center;max-width:800px">
        Tip: Tap <strong>Loop</strong> to record a pattern, tap again to loop it. Use <strong>Record</strong> to capture the full mix and <strong>Download</strong>.
      </div>
    </section>

    <!-- PIANO -->
    <section id="piano" class="page">
      <div class="piano-wrap">
        <div style="display:flex;justify-content:space-between;align-items:center;margin:4px 6px 8px">
          <div style="color:var(--txt-dim)">Piano ¬∑ 2 octaves (C4‚ÄìB5)</div>
          <div style="display:flex;gap:.4rem">
            <button class="btn pill" id="pianoDown">Oct‚Äì</button>
            <button class="btn pill" id="pianoUp">Oct+</button>
          </div>
        </div>
        <div id="pianoKeys" class="piano" aria-label="Piano keyboard"></div>
      </div>
    </section>

    <!-- GUITAR -->
    <section id="guitar" class="page">
      <div class="fretboard">
        <div style="display:flex;justify-content:space-between;align-items:center;margin:2px 4px 8px">
          <div style="color:var(--txt-dim)">Guitar ¬∑ 6 strings (E2‚ÄìE4), 0‚Äì12 frets</div>
          <div style="display:flex;gap:.4rem">
            <button class="btn pill on" id="gAcoustic">Acoustic</button>
            <button class="btn pill" id="gElectric">Electric</button>
          </div>
        </div>
        <div id="guitarBoard" class="board" aria-label="Guitar fretboard">
          <div class="nut"></div>
          <div class="string"></div><div class="string"></div><div class="string"></div>
          <div class="string"></div><div class="string"></div><div class="string"></div>
          <div class="markers" id="gMarkers"></div>
          <div id="gFretNums" class="fret-number"></div>
        </div>
      </div>
    </section>

    <!-- BASS -->
    <section id="bass" class="page">
      <div class="fretboard">
        <div style="display:flex;justify-content:space-between;align-items:center;margin:2px 4px 8px">
          <div style="color:var(--txt-dim)">Bass ¬∑ 4 strings (E1‚ÄìG3), 0‚Äì12 frets</div>
          <div style="display:flex;gap:.4rem">
            <button class="btn pill on" id="bFinger">Finger</button>
            <button class="btn pill" id="bPick">Pick</button>
          </div>
        </div>
        <div id="bassBoard" class="board strings-4" aria-label="Bass fretboard">
          <div class="nut"></div>
          <div class="string"></div><div class="string"></div><div class="string"></div><div class="string"></div>
          <div class="markers" id="bMarkers"></div>
          <div id="bFretNums" class="fret-number"></div>
        </div>
      </div>
    </section>

    <!-- DRUMS -->
    <section id="drums" class="page">
      <div style="width:100%">
        <div style="display:flex;justify-content:space-between;align-items:center;margin:4px 2px 10px">
          <div style="color:var(--txt-dim)">Drum Kit ¬∑ Pads</div>
          <div style="display:flex;gap:.4rem">
            <button class="btn pill" id="drumTight">Tight</button>
            <button class="btn pill on" id="drumRoom">Room</button>
          </div>
        </div>
        <div class="drums" id="drumPads"></div>
      </div>
    </section>
  </main>
</div>

<!-- Tap-to-start overlay (iOS audio unlock) -->
<div id="startOverlay">
  <div class="box">
    <h3 style="margin:.2rem 0 0">Music Messer</h3>
    <p style="color:var(--txt-dim)">Tap to enable sound and start</p>
    <button id="startBtn" class="btn pill on" style="margin-top:.3rem">Tap to Start</button>
  </div>
</div>

<script>
/* ========= Audio Engine (WebAudio) ========= */
const Audio = (() => {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const master = ctx.createGain(); master.gain.value = 0.9;

  // Dynamics/limiter
  const comp = ctx.createDynamicsCompressor();
  comp.threshold.value = -14; comp.knee.value=18; comp.ratio.value=4;
  comp.attack.value=0.003; comp.release.value=0.25;

  master.connect(comp); comp.connect(ctx.destination);

  // Recorder tap
  const mixOut = ctx.createGain(); mixOut.gain.value = 1.0;
  comp.connect(mixOut);
  const recDest = ctx.createMediaStreamDestination();

  mixOut.connect(recDest);

  function now(){ return ctx.currentTime; }
  function env(node, a=0.002, d=0.15, s=0.0, r=0.2, peak=1, sus=0.0){
    const t = now(), g = node.gain;
    g.cancelScheduledValues(t);
    g.setValueAtTime(0, t);
    g.linearRampToValueAtTime(peak, t+a);
    g.linearRampToValueAtTime(sus, t+a+d);
    g.linearRampToValueAtTime(0, t+a+d+r);
  }

  // SAFE panner output (fix for iOS without createStereoPanner)
  function panOut(){
    const g = ctx.createGain();
    let panner = null;
    if (typeof ctx.createStereoPanner === 'function') {
      panner = ctx.createStereoPanner();
      g.connect(panner); panner.connect(master);
      return {in:g, setPan:(v)=>{panner.pan.value=v}};
    } else {
      // No stereo panner: connect directly
      g.connect(master);
      return {in:g, setPan:(_v)=>{}};
    }
  }

  // Piano
  function pianoNote(freq, vel=0.9){
    const {in,setPan} = panOut();
    setPan((Math.random()*2-1)*0.2);
    const o1 = ctx.createOscillator(); o1.type='triangle'; o1.frequency.value=freq;
    const o2 = ctx.createOscillator(); o2.type='sawtooth'; o2.frequency.value=freq*0.999;
    const o3 = ctx.createOscillator(); o3.type='sawtooth'; o3.frequency.value=freq*1.002;

    const g = ctx.createGain(); g.gain.value=0;
    const lp = ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value = Math.min(12000, freq*6); lp.Q.value=0.4;

    o1.connect(g); o2.connect(g); o3.connect(g);
    g.connect(lp); lp.connect(in);

    env(g, 0.002, 0.2, 0.2, 1.2, vel, 0.18);
    const t = now();
    o1.start(t); o2.start(t); o3.start(t);
    o1.stop(t+2.5); o2.stop(t+2.5); o3.stop(t+2.5);
  }

  // Pluck (guitar/bass)
  function pluck(freq, vel=0.9, tone='guitar'){
    const {in,setPan} = panOut();
    setPan((Math.random()*2-1)*0.25);
    const sine = ctx.createOscillator(); sine.type='sine'; sine.frequency.setValueAtTime(freq, now());
    const gSine = ctx.createGain(); gSine.gain.value=0; sine.connect(gSine);

    // noise burst
    const noiseBuf = ctx.createBuffer(1, ctx.sampleRate*0.2, ctx.sampleRate);
    const data = noiseBuf.getChannelData(0);
    for(let i=0;i<data.length;i++) data[i] = (Math.random()*2-1) * (1 - i/data.length);
    const noise = ctx.createBufferSource(); noise.buffer=noiseBuf;
    const gNoise = ctx.createGain(); gNoise.gain.value=0.0; noise.connect(gNoise);

    const lp = ctx.createBiquadFilter(); lp.type='lowpass';
    const hp = ctx.createBiquadFilter(); hp.type='highpass';
    if(tone==='electric'){ lp.frequency.value = Math.min(8000, freq*8); lp.Q.value=0.8; hp.frequency.value=60; }
    else if(tone==='bass'){ lp.frequency.value = Math.min(6000, freq*6); lp.Q.value=0.6; hp.frequency.value=40; }
    else { lp.frequency.value = Math.min(7000, freq*7); lp.Q.value=0.7; hp.frequency.value=55; }

    gNoise.connect(lp); gSine.connect(lp); lp.connect(hp); hp.connect(in);
    env(gNoise, 0.001, 0.05, 0.0, 0.15, vel*0.9, 0);
    env(gSine, 0.001, 0.12, 0.0, tone==='bass'? 1.0 : 0.8, vel*0.8, 0);

    const t = now();
    sine.start(t);
    noise.start(t);
    noise.stop(t+0.25);
    sine.stop(t+(tone==='bass'? 2.2:1.8));
  }

  // Drums
  function kick(vel=1){
    const {in} = panOut();
    const o = ctx.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(130, now());
    o.frequency.exponentialRampToValueAtTime(45, now()+0.15);
    const g = ctx.createGain(); g.gain.value=0; o.connect(g); g.connect(in);
    env(g, 0.001, 0.12, 0, 0.25, vel*1.4, 0);
    o.start(); o.stop(now()+0.5);
  }
  function snare(vel=1){
    const {in} = panOut();
    const nB = noise(0.18); const gN = ctx.createGain(); gN.gain.value=0; nB.connect(gN);
    const bp = ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1800; bp.Q.value=0.8;
    gN.connect(bp); bp.connect(in);
    env(gN, 0.001, 0.08, 0, 0.18, vel*1.2, 0);
    const t = now(); nB.start(t); nB.stop(t+0.25);
  }
  function hihat(closed=true, vel=0.9){
    const {in} = panOut();
    const nB = noise(0.08); const g = ctx.createGain(); g.gain.value=0; nB.connect(g);
    const hp = ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=5000; hp.Q.value=0.7;
    g.connect(hp); hp.connect(in);
    env(g, 0.0005, closed?0.03:0.12, 0, closed?0.06:0.3, vel, 0);
    const t = now(); nB.start(t); nB.stop(t+(closed?0.12:0.4));
  }
  function tom(freq=160, vel=1){
    const {in} = panOut();
    const o = ctx.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(freq, now());
    const g = ctx.createGain(); g.gain.value=0; o.connect(g); g.connect(in);
    env(g, 0.001, 0.08, 0, 0.35, vel, 0);
    o.start(); o.stop(now()+0.7);
  }
  function crash(vel=1){
    const {in} = panOut();
    const nB = noise(0.6); const g = ctx.createGain(); g.gain.value=0; nB.connect(g);
    const hp = ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=7000; hp.Q.value=0.6;
    g.connect(hp); hp.connect(in);
    env(g, 0.001, 0.15, 0.0, 1.2, vel, 0);
    const t = now(); nB.start(t); nB.stop(t+1.5);
  }
  function noise(len=0.2){
    const bs = ctx.sampleRate*len;
    const buf = ctx.createBuffer(1, bs, ctx.sampleRate);
    const d = buf.getChannelData(0);
    for(let i=0;i<bs;i++) d[i] = Math.random()*2-1;
    const src = ctx.createBufferSource(); src.buffer=buf;
    return src;
  }

  return { ctx, recDest, pianoNote, pluck, kick, snare, hihat, tom, crash };
})();

/* ========= Router & UI ========= */
const pages=["home","piano","guitar","bass","drums"];
let current="home";
const els={}; pages.forEach(id=>els[id]=document.getElementById(id));
const backBtn=document.getElementById('backBtn');
function show(id){ pages.forEach(p=>els[p].classList.toggle('active',p===id)); current=id; backBtn.classList.toggle('hidden',id==="home"); }
document.querySelectorAll('.card').forEach(c=>c.addEventListener('click',()=>{ resumeAudio(); show(c.dataset.nav);} ));
backBtn.addEventListener('click',()=>show('home'));

function resumeAudio(){ if(Audio.ctx.state!=='running') Audio.ctx.resume(); }

/* ========= Loop Sequencer ========= */
let isLooping=false, loopStart=0, loopMs=0; const loopEvents=[];
const loopBtn=document.getElementById('loopBtn'); const clearLoopBtn=document.getElementById('clearLoopBtn');
loopBtn.addEventListener('click', ()=>{
  resumeAudio();
  if(!isLooping && loopEvents.length===0){ loopStart=performance.now(); loopMs=0; isLooping=true; loopBtn.classList.add('on'); loopBtn.textContent='Stop & Loop'; }
  else if(isLooping){ loopMs=Math.max(300, performance.now()-loopStart); isLooping=false; loopBtn.classList.add('on'); loopBtn.textContent='Looping‚Ä¶ (tap to re-arm)'; runLoop(); }
  else { loopEvents.length=0; loopStart=performance.now(); loopMs=0; isLooping=true; loopBtn.classList.add('on'); loopBtn.textContent='Stop & Loop'; }
});
clearLoopBtn.addEventListener('click', ()=>{ loopEvents.length=0; loopMs=0; isLooping=false; loopBtn.classList.remove('on'); loopBtn.textContent='Loop'; });
function addLoopEvent(fn){ if(isLooping){ const tMs=performance.now()-loopStart; loopEvents.push({tMs, play:fn}); } }
function runLoop(){
  if(loopEvents.length===0 || loopMs<=0){ loopBtn.classList.remove('on'); loopBtn.textContent='Loop'; return; }
  loopEvents.forEach(ev=> setTimeout(()=>ev.play(), Math.max(0, ev.tMs)) );
  setTimeout(runLoop, loopMs);
}

/* ========= Recorder (Safari-safe) ========= */
let mediaRecorder=null, chunks=[], lastBlob=null, lastURL=null, recMime='', recExt='webm';
const recBtn=document.getElementById('recBtn'), stopRecBtn=document.getElementById('stopRecBtn'), playRecBtn=document.getElementById('playRecBtn'), dlLink=document.getElementById('dlLink');
const playerEl=document.createElement('audio'); playerEl.controls=true;

function pickMime(){
  if (window.MediaRecorder && MediaRecorder.isTypeSupported) {
    if (MediaRecorder.isTypeSupported('audio/mp4')) { recMime='audio/mp4'; recExt='m4a'; return; }
    if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) { recMime='audio/webm;codecs=opus'; recExt='webm'; return; }
    if (MediaRecorder.isTypeSupported('audio/webm')) { recMime='audio/webm'; recExt='webm'; return; }
  }
  recMime=''; recExt='webm';
}
pickMime();
dlLink.textContent='‚¨á Download'; dlLink.href='javascript:void(0)'; dlLink.setAttribute('download','');

recBtn.addEventListener('click', ()=>{
  resumeAudio();
  if(!window.MediaRecorder){ alert('Recording not supported in this browser.'); return; }
  if(mediaRecorder && mediaRecorder.state==='recording') return;
  try{
    mediaRecorder = recMime ? new MediaRecorder(Audio.recDest.stream, {mimeType:recMime}) : new MediaRecorder(Audio.recDest.stream);
  }catch(e){
    alert('Recording failed to start. Try Safari/Chrome latest.'); return;
  }
  chunks=[];
  mediaRecorder.ondataavailable = e=>{ if(e.data && e.data.size>0) chunks.push(e.data); };
  mediaRecorder.onstop = ()=>{
    if(lastURL){ URL.revokeObjectURL(lastURL); lastURL=null; }
    lastBlob = new Blob(chunks, {type: recMime || 'audio/webm'});
    lastURL = URL.createObjectURL(lastBlob);
    dlLink.href = lastURL;
    dlLink.download = `music-messer-recording.${recExt}`;
    playRecBtn.disabled = false;
    playerEl.src = lastURL;
    const host = els[current]; if(!playerEl.isConnected) host.appendChild(playerEl);
  };
  mediaRecorder.start();
  recBtn.classList.add('on'); recBtn.textContent='‚óè Recording‚Ä¶';
});
stopRecBtn.addEventListener('click', ()=>{
  if(mediaRecorder && mediaRecorder.state==='recording'){ mediaRecorder.stop(); }
  recBtn.classList.remove('on'); recBtn.textContent='‚óè Record';
});
playRecBtn.addEventListener('click', ()=>{ if(playerEl.src) playerEl.play(); });

/* ========= Instruments ========= */
const pianoKeysEl=document.getElementById('pianoKeys');
let pianoBaseOct=4;
function midiToFreq(m){ return 440 * Math.pow(2, (m-69)/12); }
const whiteOrder=['C','D','E','F','G','A','B'];
const blackMap={ 'C':true,'D':true,'F':true,'G':true,'A':true };

function buildPiano(){
  pianoKeysEl.innerHTML='';
  const octaves=2; const startMidi=60 + (pianoBaseOct-4)*12;
  let midi=startMidi;
  for(let o=0;o<octaves;o++){
    for(const note of whiteOrder){
      const w=document.createElement('div'); w.className='white';
      const label=document.createElement('div'); label.className='label'; label.textContent=note+(pianoBaseOct+o);
      w.appendChild(label); w.dataset.midi=midi;
      w.addEventListener('pointerdown', e=>{ e.preventDefault(); resumeAudio(); playPiano(w.dataset.midi|0); });
      pianoKeysEl.appendChild(w);
      if(blackMap[note]){
        const b=document.createElement('div'); b.className='black'; b.dataset.midi=midi+1;
        b.addEventListener('pointerdown', e=>{ e.preventDefault(); resumeAudio(); playPiano(b.dataset.midi|0); });
        w.appendChild(b); midi+=2;
      } else { midi+=1; }
    }
  }
}
function playPiano(midi){ const f=midiToFreq(midi); Audio.pianoNote(f,0.95); addLoopEvent(()=>Audio.pianoNote(f,0.95)); }
document.getElementById('pianoUp').addEventListener('click', ()=>{ pianoBaseOct=Math.min(6,pianoBaseOct+1); buildPiano(); });
document.getElementById('pianoDown').addEventListener('click', ()=>{ pianoBaseOct=Math.max(2,pianoBaseOct-1); buildPiano(); });

function buildFretMarkers(containerId, numbersId){
  const el=document.getElementById(containerId), nums=document.getElementById(numbersId);
  el.innerHTML=''; nums.innerHTML='';
  const frets=13;
  for(let f of [3,5,7,9]){ const d=document.createElement('div'); d.className='dot'; d.style.left=((f+0.5)/frets*100)+'%'; d.style.top='50%'; el.appendChild(d); }
  const d1=document.createElement('div'); d1.className='dot'; d1.style.left=((12.5)/frets*100)+'%'; d1.style.top='40%'; el.appendChild(d1);
  const d2=document.createElement('div'); d2.className='dot'; d2.style.left=((12.5)/frets*100)+'%'; d2.style.top='60%'; el.appendChild(d2);
  for(let f=0; f<=12; f++){ const s=document.createElement('span'); s.textContent=f; s.style.position='absolute'; s.style.left=((f+0.5)/frets*100)+'%'; s.style.transform='translateX(-50%)'; s.style.bottom='6px'; s.style.color='#6c6d78'; s.style.fontSize='12px'; nums.appendChild(s); }
}
const guitarTun=[82.41,110.00,146.83,196.00,246.94,329.63];
const bassTun=[41.20,55.00,73.42,98.00];
function posToFret(x,w){ const frets=13; const frac=x/w; return Math.max(0, Math.min(12, Math.round(frac*(frets-1)))); }
function stringIndex(y,h,strings){ return Math.max(0, Math.min(strings-1, Math.round((y/h)*(strings-1)))); }

const guitarBoard=document.getElementById('guitarBoard');
const bassBoard=document.getElementById('bassBoard');
let guitarMode='acoustic';
document.getElementById('gAcoustic').addEventListener('click',()=>{guitarMode='acoustic';toggleBtn('gAcoustic','gElectric');});
document.getElementById('gElectric').addEventListener('click',()=>{guitarMode='electric';toggleBtn('gElectric','gAcoustic');});
let bassMode='finger';
document.getElementById('bFinger').addEventListener('click',()=>{bassMode='finger';toggleBtn('bFinger','bPick');});
document.getElementById('bPick').addEventListener('click',()=>{bassMode='pick';toggleBtn('bPick','bFinger');});
function toggleBtn(onId, offId){ document.getElementById(onId).classList.add('on'); document.getElementById(offId).classList.remove('on'); }

function setupBoard(boardEl, strings, tuning, tone){
  boardEl.addEventListener('pointerdown', e=>{
    resumeAudio();
    const r=boardEl.getBoundingClientRect(); const x=e.clientX-r.left; const y=e.clientY-r.top;
    const fret=posToFret(x,r.width); const sIdx=stringIndex(y,r.height,strings);
    const open=tuning[sIdx]; const freq=open*Math.pow(2,fret/12);
    const play=()=>Audio.pluck(freq,0.95, tone());
    play(); addLoopEvent(play);
  });
}
setupBoard(guitarBoard,6,guitarTun, ()=> (guitarMode==='electric'?'electric':'guitar'));
setupBoard(bassBoard,4,bassTun, ()=> 'bass');

const drumPadsEl=document.getElementById('drumPads');
const DRUMS=[ {name:'Kick', fn:()=>Audio.kick(1)}, {name:'Snare', fn:()=>Audio.snare(1)}, {name:'CHat', fn:()=>Audio.hihat(true,1)}, {name:'OHat', fn:()=>Audio.hihat(false,1)}, {name:'Tom L', fn:()=>Audio.tom(140,1)}, {name:'Tom H', fn:()=>Audio.tom(190,1)}, {name:'Crash', fn:()=>Audio.crash(1)} ];
function buildDrums(){ drumPadsEl.innerHTML=''; DRUMS.forEach(d=>{ const pad=document.createElement('button'); pad.className='pad'; pad.textContent=d.name; pad.addEventListener('pointerdown',e=>{ e.preventDefault(); resumeAudio(); d.fn(); addLoopEvent(d.fn); }); drumPadsEl.appendChild(pad); }); }
document.getElementById('drumRoom').addEventListener('click', function(){ this.classList.add('on'); document.getElementById('drumTight').classList.remove('on'); });
document.getElementById('drumTight').addEventListener('click', function(){ this.classList.add('on'); document.getElementById('drumRoom').classList.remove('on'); });

/* ========= Start overlay (iOS unlock) ========= */
const startOverlay=document.getElementById('startOverlay');
document.getElementById('startBtn').addEventListener('click', async ()=>{
  try{ await Audio.ctx.resume(); }catch(e){}
  startOverlay.remove();
});

/* ========= Init ========= */
function init(){
  buildPiano();
  buildFretMarkers('gMarkers','gFretNums');
  buildFretMarkers('bMarkers','bFretNums');
  buildDrums();
}
addEventListener('resize', ()=>{ if(current==='piano') buildPiano(); });
init();
</script>
</body>
</html>
